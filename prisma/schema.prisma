generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

generator nestgraphql {
  provider   = "node node_modules/prisma-nestjs-graphql"
  output     = "../src/lib/graphql/prisma-client"
  reExport   = None
  emitSingle = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  password String
  name     String

  role Role

  accounts                   Account[]
  investments                Investment[]
  transactions               Transaction[]
  cardBillingStatusHistories CardBillingHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Institution {
  id      String        @id @default(uuid())
  code    String
  name    String
  logoUrl String?
  color   String?
  types   AccountType[]

  accounts Account[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id             String      @id @default(uuid())
  name           String
  type           AccountType
  initialBalance Decimal     @default(0)
  description    String?
  isActive       Boolean     @default(true)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId String

  accountCard AccountCard?

  sourceTransactions     Transaction[]           @relation("SourceAccount")
  destinyTransactions    Transaction[]           @relation("DestinyAccount")
  investments            Investment[]
  investmentTransactions InvestmentTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AccountCard {
  id String @id @default(uuid())

  lastFourDigits    String?
  billingCycleDay   Int
  billingPaymentDay Int
  type              CardType
  defaultLimit      Decimal

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId String  @unique

  billings CardBilling[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CardBilling {
  id String @id @default(uuid())

  periodStart DateTime
  periodEnd   DateTime?
  paymentDate DateTime?
  limit       Decimal

  status CardBillingStatus

  accountCard   AccountCard @relation(fields: [accountCardId], references: [id], onDelete: Cascade)
  accountCardId String

  paymentTransaction   Transaction? @relation(fields: [paymentTransactionId], references: [id], name: "BillingPayment")
  paymentTransactionId String?      @unique

  transactions  Transaction[]        @relation(name: "BillingTransactions")
  statusHistory CardBillingHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountCardId, periodStart])
  @@index([accountCardId])
  @@index([paymentDate])
}

model CardBillingHistory {
  id        String            @id @default(uuid())
  status    CardBillingStatus
  changedAt DateTime          @default(now())

  cardBilling   CardBilling @relation(fields: [cardBillingId], references: [id], onDelete: Cascade)
  cardBillingId String

  changedBy   User?   @relation(fields: [changedById], references: [id], onDelete: SetNull)
  changedById String?

  @@index([cardBillingId])
  @@index([changedById])
  @@index([changedAt])
}

model Investment {
  id              String    @id @default(uuid())
  amount          Float
  correctedAmount Float?
  taxedAmount     Float?
  startDate       DateTime
  duration        Int?
  finishedAt      DateTime?
  lastCorrectedAt DateTime?

  status InvestmentStatus @default(OPEN)

  regimeName       Regime
  regimePercentage Float? @default(100)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId String

  transactions InvestmentTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InvestmentTransaction {
  id     String                    @id @default(uuid())
  role   InvestmentTransactionRole
  amount Decimal

  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  investmentId String

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investmentId])
  @@index([accountId])
}

model Transaction {
  id            String            @id @default(uuid())
  description   String
  amount        Decimal
  date          DateTime
  status        TransactionStatus
  type          TransactionType
  paymentMethod PaymentMethod

  sourceAccount   Account? @relation(fields: [sourceAccountId], references: [id], onDelete: Cascade, name: "SourceAccount")
  sourceAccountId String?

  destinyAccount   Account? @relation(fields: [destinyAccountId], references: [id], onDelete: Cascade, name: "DestinyAccount")
  destinyAccountId String?

  billingPayment CardBilling? @relation(name: "BillingPayment")

  cardBilling   CardBilling? @relation(fields: [cardBillingId], references: [id], onDelete: SetNull, name: "BillingTransactions")
  cardBillingId String?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AccountType {
  WALLET // Carteira física
  CHECKING // Conta corrente
  SAVINGS // Poupança
  INVESTMENT // Investimentos
  CREDIT_CARD // Cartão de crédito
  OTHER // Outros tipos
}

enum CardType {
  CREDIT
  DEBIT
}

enum CardBillingStatus {
  PENDING
  CLOSED
  PAID
  OVERDUE
  COMPLETED
}

enum PaymentMethod {
  CASH
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
}

enum InvestmentStatus {
  OPEN
  CLOSED
}

enum Role {
  ADMIN
  USER
}

enum Regime {
  CDI
  POUPANCA
}

enum InvestmentTransactionRole {
  FUNDING
  REDEMPTION
  INCOME
  FEE
}

enum TransactionStatus {
  PLANNED
  COMPLETED
  CANCELED
}

enum TransactionType {
  INCOME
  EXPENSE
  BETWEEN_ACCOUNTS
}
